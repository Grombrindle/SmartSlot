<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Appointment - Customer Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .sidebar { position: fixed; top: 0; left: 0; height: 100vh; width: 250px; background-color: #f8f9fa; border-right: 1px solid #dee2e6; }
        .main-content { margin-left: 250px; padding: 20px; }
        .nav-link { color: #495057; padding: 10px 15px; border-radius: 5px; margin: 2px 0; }
        .nav-link:hover { background-color: #e9ecef; color: #0d6efd; }
        .nav-link.active { background-color: #0d6efd; color: white; }
        .time-slot { padding: 10px; margin: 5px; border: 1px solid #dee2e6; border-radius: 5px; cursor: pointer; }
        .time-slot:hover { background-color: #e9ecef; }
        .time-slot.selected { background-color: #0d6efd; color: white; }
        .staff-card { transition: transform 0.2s; cursor: pointer; }
        .staff-card:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .staff-card.selected { border-color: #0d6efd; background-color: #f0f8ff; }
    </style>
</head>
<body>
    <div class="sidebar d-flex flex-column">
        <div class="p-3 border-bottom">
            <h4 class="mb-0 text-primary"><i class="bi bi-calendar-check"></i> Customer Portal</h4>
            <small class="text-muted" sec:authentication="name"></small>
        </div>
        <nav class="nav flex-column p-3">
            <h6 class="text-uppercase text-muted mb-2">Navigation</h6>
            <a href="/dashboard" class="nav-link"><i class="bi bi-house"></i> Dashboard</a>
            <div sec:authorize="hasRole('CUSTOMER')">
                <hr class="my-2">
                <h6 class="text-uppercase text-muted mb-2">Customer Panel</h6>
                <a href="/customer/book" class="nav-link active"><i class="bi bi-calendar-plus"></i> Book Appointment</a>
                <a href="/customer/appointments" class="nav-link"><i class="bi bi-calendar-week"></i> My Appointments</a>
                <a href="/customer/profile" class="nav-link"><i class="bi bi-person"></i> My Profile</a>
                <a href="/customer/history" class="nav-link"><i class="bi bi-clock-history"></i> History</a>
            </div>
            <div class="mt-auto p-3">
                <form th:action="@{/logout}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-outline-danger w-100"><i class="bi bi-box-arrow-right"></i> Logout</button>
                </form>
            </div>
        </nav>
    </div>

    <div class="main-content">
        <h1><i class="bi bi-calendar-plus"></i> Book Appointment</h1>
        <p class="text-muted mb-4">Select service, staff, and available time slot</p>

        <!-- Booking Steps -->
        <div class="row">
            <div class="col-md-8">
                <!-- Step 1: Select Service -->
                <div class="card mb-4" id="step1">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Step 1: Select Service</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="servicesList">
                            <!-- Services loaded by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Step 2: Select Staff -->
                <div class="card mb-4" id="step2" style="display: none;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Step 2: Select Staff</h5>
                    </div>
                    <div class="card-body">
                        <div class="row" id="staffList">
                            <!-- Staff loaded by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Step 3: Select Date & Time -->
                <div class="card mb-4" id="step3" style="display: none;">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Step 3: Select Date & Time</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Select Date</label>
                                <input type="date" class="form-control" id="bookingDate" min="">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Available Time Slots</label>
                                <div id="timeSlots" class="d-flex flex-wrap">
                                    <!-- Time slots loaded by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Confirm Booking -->
                <div class="card" id="step4" style="display: none;">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Step 4: Confirm Booking</h5>
                    </div>
                    <div class="card-body">
                        <div id="bookingSummary">
                            <!-- Booking summary -->
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Additional Notes (Optional)</label>
                            <textarea class="form-control" id="bookingNotes" rows="3" placeholder="Any special requests or notes..."></textarea>
                        </div>
                        <button class="btn btn-success btn-lg w-100" onclick="confirmBooking()">
                            <i class="bi bi-check-circle"></i> Confirm Appointment
                        </button>
                    </div>
                </div>
            </div>

            <!-- Booking Progress -->
            <div class="col-md-4">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Booking Progress</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-briefcase"></i> Select Service
                                    <div class="text-muted small" id="selectedServiceText">Not selected</div>
                                </div>
                                <span class="badge bg-secondary rounded-pill">1</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-person"></i> Select Staff
                                    <div class="text-muted small" id="selectedStaffText">Not selected</div>
                                </div>
                                <span class="badge bg-secondary rounded-pill">2</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-clock"></i> Select Time
                                    <div class="text-muted small" id="selectedTimeText">Not selected</div>
                                </div>
                                <span class="badge bg-secondary rounded-pill">3</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="bi bi-check-circle"></i> Confirm
                                    <div class="text-muted small">Complete booking</div>
                                </div>
                                <span class="badge bg-secondary rounded-pill">4</span>
                            </div>
                        </div>
                        
                        <hr>
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="previousStep()" id="prevBtn" disabled>
                                <i class="bi bi-arrow-left"></i> Previous
                            </button>
                            <button class="btn btn-primary" onclick="nextStep()" id="nextBtn">
                                Next <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStep = 1;
        let selectedService = null;
        let selectedStaff = null;
        let selectedDateTime = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            loadServices();
            setMinDate();
        });
        
        function setMinDate() {
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1); // Minimum 24 hours advance
            const minDate = tomorrow.toISOString().split('T')[0];
            document.getElementById('bookingDate').min = minDate;
            document.getElementById('bookingDate').value = minDate;
        }
        
        async function loadServices() {
            try {
                const response = await fetch('/api/services?size=100', {
                    headers: {
                        'Authorization': 'Bearer ' + getJwtToken()
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    renderServices(result.data.content || []);
                }
            } catch (error) {
                console.error('Error loading services:', error);
            }
        }
        
        function renderServices(services) {
            const container = document.getElementById('servicesList');
            container.innerHTML = '';
            
            services.forEach(service => {
                const col = document.createElement('div');
                col.className = 'col-md-6 mb-3';
                col.innerHTML = `
                    <div class="card staff-card" onclick="selectService(${service.id}, '${service.name}', ${service.duration}, ${service.price}, ${service.providerId})">
                        <div class="card-body">
                            <h5 class="card-title">${service.name}</h5>
                            <p class="card-text text-muted">${service.description || 'No description'}</p>
                            <div class="d-flex justify-content-between">
                                <span class="badge bg-primary">${service.duration} min</span>
                                <span class="badge bg-success">$${service.price.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }
        
        async function selectService(serviceId, serviceName, duration, price, providerId) {
            selectedService = { id: serviceId, name: serviceName, duration, price, providerId };
            
            // Update progress
            document.getElementById('selectedServiceText').textContent = serviceName;
            
            // Load staff for this service
            await loadStaff(providerId);
            
            // Highlight selected
            document.querySelectorAll('.staff-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Enable next step
            document.getElementById('nextBtn').disabled = false;
        }
        
        async function loadStaff(staffId) {
            try {
                // For now, just get the specific staff
                const response = await fetch(`/api/users/${staffId}`, {
                    headers: {
                        'Authorization': 'Bearer ' + getJwtToken()
                    }
                });
                
                if (response.ok) {
                    const staff = await response.json();
                    renderStaff([staff.data]);
                }
            } catch (error) {
                console.error('Error loading staff:', error);
            }
        }
        
        function renderStaff(staffList) {
            const container = document.getElementById('staffList');
            container.innerHTML = '';
            
            staffList.forEach(staff => {
                const col = document.createElement('div');
                col.className = 'col-md-12';
                col.innerHTML = `
                    <div class="card staff-card" onclick="selectStaff(${staff.id}, '${staff.name}', '${staff.specialty || 'Staff'}')">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                                     style="width: 60px; height: 60px; font-size: 1.5rem;">
                                    ${staff.name.charAt(0)}
                                </div>
                                <div class="ms-3">
                                    <h5 class="mb-1">${staff.name}</h5>
                                    <p class="mb-0 text-muted">${staff.specialty || 'Service Provider'}</p>
                                    ${staff.licenseNumber ? `<small class="text-muted">License: ${staff.licenseNumber}</small>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }
        
        function selectStaff(staffId, staffName, specialty) {
            selectedStaff = { id: staffId, name: staffName, specialty };
            
            // Update progress
            document.getElementById('selectedStaffText').textContent = `${staffName} (${specialty})`;
            
            // Highlight selected
            document.querySelectorAll('.staff-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Load available time slots
            loadTimeSlots();
        }
        
        async function loadTimeSlots() {
            const date = document.getElementById('bookingDate').value;
            if (!date || !selectedStaff || !selectedService) return;
            
            try {
                const response = await fetch(`/api/schedule/available-slots?staffId=${selectedStaff.id}&serviceId=${selectedService.id}&date=${date}`, {
                    headers: {
                        'Authorization': 'Bearer ' + getJwtToken()
                    }
                });
                
                if (response.ok) {
                    const slots = await response.json();
                    renderTimeSlots(slots.data || []);
                }
            } catch (error) {
                console.error('Error loading time slots:', error);
            }
        }
        
        function renderTimeSlots(slots) {
            const container = document.getElementById('timeSlots');
            container.innerHTML = '';
            
            if (slots.length === 0) {
                container.innerHTML = '<div class="alert alert-info">No available slots for this date</div>';
                return;
            }
            
            slots.forEach(slot => {
                const time = document.createElement('div');
                time.className = 'time-slot';
                time.textContent = new Date(slot.startTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                time.onclick = function() {
                    selectTimeSlot(slot.startTime, slot.endTime);
                    document.querySelectorAll('.time-slot').forEach(t => t.classList.remove('selected'));
                    this.classList.add('selected');
                };
                container.appendChild(time);
            });
        }
        
        function selectTimeSlot(startTime, endTime) {
            selectedDateTime = startTime;
            
            // Update progress
            const timeStr = new Date(startTime).toLocaleString();
            document.getElementById('selectedTimeText').textContent = timeStr;
        }
        
        function nextStep() {
            // Hide current step
            document.getElementById(`step${currentStep}`).style.display = 'none';
            
            // Show next step
            currentStep++;
            document.getElementById(`step${currentStep}`).style.display = 'block';
            
            // Update buttons
            document.getElementById('prevBtn').disabled = currentStep === 1;
            
            if (currentStep === 4) {
                document.getElementById('nextBtn').style.display = 'none';
                updateBookingSummary();
            }
        }
        
        function previousStep() {
            // Hide current step
            document.getElementById(`step${currentStep}`).style.display = 'none';
            
            // Show previous step
            currentStep--;
            document.getElementById(`step${currentStep}`).style.display = 'block';
            
            // Update buttons
            document.getElementById('prevBtn').disabled = currentStep === 1;
            document.getElementById('nextBtn').style.display = 'block';
        }
        
        function updateBookingSummary() {
            const summary = document.getElementById('bookingSummary');
            summary.innerHTML = `
                <div class="alert alert-success">
                    <h5>Booking Summary</h5>
                    <hr>
                    <p><strong>Service:</strong> ${selectedService.name}</p>
                    <p><strong>Duration:</strong> ${selectedService.duration} minutes</p>
                    <p><strong>Price:</strong> $${selectedService.price.toFixed(2)}</p>
                    <p><strong>Provider:</strong> ${selectedStaff.name} (${selectedStaff.specialty})</p>
                    <p><strong>Date & Time:</strong> ${new Date(selectedDateTime).toLocaleString()}</p>
                </div>
            `;
        }
        
        async function confirmBooking() {
            const csrfToken = document.querySelector('input[name="_csrf"]').value;
            
            const bookingData = {
                staffId: selectedStaff.id,
                serviceId: selectedService.id,
                appointmentDateTime: selectedDateTime,
                notes: document.getElementById('bookingNotes').value
            };
            
            try {
                const response = await fetch('/api/appointments/book', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getJwtToken(),
                        'X-CSRF-TOKEN': csrfToken
                    },
                    body: JSON.stringify(bookingData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showAlert('Appointment booked successfully!', 'success');
                    
                    // Reset form
                    setTimeout(() => {
                        window.location.href = '/customer/appointments';
                    }, 2000);
                } else {
                    const error = await response.json();
                    showAlert(error.message || 'Booking failed', 'danger');
                }
            } catch (error) {
                console.error('Error booking appointment:', error);
                showAlert('Booking failed. Please try again.', 'danger');
            }
        }
        
        function getJwtToken() {
            return localStorage.getItem('jwtToken') || '';
        }
        
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show mt-3`;
            alert.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.querySelector('.main-content').prepend(alert);
            setTimeout(() => alert.remove(), 5000);
        }
    </script>
</body>
</html>