<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Working Schedules - Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .sidebar { position: fixed; top: 0; left: 0; height: 100vh; width: 250px; background-color: #f8f9fa; border-right: 1px solid #dee2e6; }
        .main-content { margin-left: 250px; padding: 20px; }
        .nav-link { color: #495057; padding: 10px 15px; border-radius: 5px; margin: 2px 0; }
        .nav-link:hover { background-color: #e9ecef; color: #0d6efd; }
        .nav-link.active { background-color: #0d6efd; color: white; }
        .badge-working { background-color: #28a745; }
        .badge-holiday { background-color: #6c757d; }
        .badge-covered { background-color: #28a745; }
        .badge-not-covered { background-color: #dc3545; }
        .table-responsive { max-height: 60vh; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="sidebar d-flex flex-column">
        <div class="p-3 border-bottom">
            <h4 class="mb-0 text-primary"><i class="bi bi-calendar-check"></i> Appointment System</h4>
            <small class="text-muted" sec:authentication="name"></small>
        </div>
        <nav class="nav flex-column p-3">
            <h6 class="text-uppercase text-muted mb-2">Navigation</h6>
            <a href="/dashboard" class="nav-link"><i class="bi bi-house"></i> Dashboard</a>
            <div sec:authorize="hasRole('ADMIN')">
                <hr class="my-2">
                <h6 class="text-uppercase text-muted mb-2">Admin Panel</h6>
                <a href="/admin/users" class="nav-link"><i class="bi bi-people"></i> Manage Users</a>
                <a href="/admin/services" class="nav-link"><i class="bi bi-briefcase"></i> Manage Services</a>
                <a href="/admin/schedules" class="nav-link active"><i class="bi bi-clock"></i> Working Schedules</a>
                <a href="/admin/appointments" class="nav-link"><i class="bi bi-calendar-event"></i> All Appointments</a>
            </div>
            <div class="mt-auto p-3">
                <form th:action="@{/logout}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-outline-danger w-100"><i class="bi bi-box-arrow-right"></i> Logout</button>
                </form>
            </div>
        </nav>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="bi bi-clock"></i> Working Schedules</h1>
                <p class="text-muted">Manage staff working hours and availability</p>
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                <i class="bi bi-plus-circle"></i> Add Schedule
            </button>
        </div>

        <!-- Schedules Table -->
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">All Schedules</h5>
                <span class="badge bg-light text-dark" th:text="'Total: ' + ${schedules.size()}">Total: 0</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Staff</th>
                                <th>Day</th>
                                <th>Start Time</th>
                                <th>End Time</th>
                                <th>Hours</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="schedule : ${schedules}" th:id="'schedule-' + ${schedule.id}">
                                <td>
                                    <div>
                                        <strong th:text="${schedule.staff.name}">Dr. John Smith</strong>
                                        <br>
                                        <small class="text-muted" th:text="${schedule.staff.specialty}">Dentist</small>
                                    </div>
                                </td>
                                <td>
                                    <span th:text="${schedule.dayOfWeek.name()}">MONDAY</span>
                                    <br>
                                   <small class="text-muted" th:text="${schedule.dayOfWeek.name().charAt(0) + schedule.dayOfWeek.name().substring(1).toLowerCase()}">Monday</small>
                                </td>
                                <td th:text="${#temporals.format(schedule.startTime, 'HH:mm')}">09:00</td>
                                <td th:text="${#temporals.format(schedule.endTime, 'HH:mm')}">17:00</td>
                                <td th:text="${#numbers.formatDecimal(schedule.endTime.getHour() - schedule.startTime.getHour() + (schedule.endTime.getMinute() - schedule.startTime.getMinute()) / 60.0, 1, 1)} + ' hrs'">8.0 hrs</td>
                                <td>
                                    <span th:class="${schedule.isHoliday() ? 'badge badge-holiday' : 'badge badge-working'}"
                                          th:text="${schedule.isHoliday() ? 'Holiday' : 'Working'}">
                                        Working
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-warning" data-bs-toggle="modal" 
                                                data-bs-target="#editScheduleModal"
                                                th:attr="data-id=${schedule.id}, data-staff-id=${schedule.staff.id}, data-day=${schedule.dayOfWeek.name()}, data-start=${schedule.startTime}, data-end=${schedule.endTime}, data-holiday=${schedule.isHoliday()}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" 
                                                th:attr="onclick=|deleteSchedule(${schedule.id})|"
                                                th:title="'Delete schedule for ' + ${schedule.staff.name} + ' on ' + ${schedule.dayOfWeek.name()}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${schedules.empty}">
                                <td colspan="7" class="text-center py-5">
                                    <div class="text-muted">
                                        <i class="bi bi-calendar-x h1 mb-3"></i>
                                        <p>No working schedules found</p>
                                        <button class="btn btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#addScheduleModal">
                                            <i class="bi bi-plus-circle"></i> Add First Schedule
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Staff Schedule Overview -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Staff Weekly Hours</h5>
                    </div>
                    <div class="card-body">
                        <div th:each="staff : ${staffMembers}" class="mb-4">
                            <h6 th:text="${staff.name} + ' (' + ${staff.specialty} + ')'">Dr. John Smith (Dentist)</h6>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Working Days:</span>
                                <span th:text="${staffWorkingDays.get(staff.id) != null ? staffWorkingDays.get(staff.id) : 0} + ' days'">5 days</span>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" role="progressbar" 
                                     th:style="'width: ' + ${staffWorkingDays.get(staff.id) != null ? (staffWorkingDays.get(staff.id) * 100 / 7) : 0} + '%'"
                                     th:attr="aria-valuenow=${staffWorkingDays.get(staff.id) != null ? (staffWorkingDays.get(staff.id) * 100 / 7) : 0}"
                                     th:aria-valuemax="100">
                                    <span th:text="${staffWorkingDays.get(staff.id) != null ? (staffWorkingDays.get(staff.id) * 100 / 7) + '%' : '0%'}">71%</span>
                                </div>
                            </div>
                            <small class="text-muted">Out of 7 days per week</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0">Weekly Coverage</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Day</th>
                                    <th>Staff Available</th>
                                    <th>Coverage</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="day : ${T(java.time.DayOfWeek).values()}">
                                    <td th:text="${day.name()}">MONDAY</td>
                                    <td th:text="${dayCoverage.get(day.name()) != null ? dayCoverage.get(day.name()) : 0}">2</td>
                                    <td>
                                        <span th:class="${dayCoverage.get(day.name()) != null && dayCoverage.get(day.name()) > 0 ? 'badge badge-covered' : 'badge badge-not-covered'}"
                                              th:text="${dayCoverage.get(day.name()) != null && dayCoverage.get(day.name()) > 0 ? 'Covered' : 'No Coverage'}">
                                            Covered
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Schedule Modal -->
    <div class="modal fade" id="addScheduleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Add Working Schedule</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addScheduleForm">
                        <div class="mb-3">
                            <label class="form-label">Select Staff</label>
                            <select class="form-select" name="staffId" required>
                                <option value="">Choose staff...</option>
                                <option th:each="staff : ${staffMembers}" 
                                        th:value="${staff.id}"
                                        th:text="${staff.name + ' (' + (staff.specialty != null ? staff.specialty : 'General') + ')'}">
                                    Dr. John Smith (Dentist)
                                </option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Day of Week</label>
                            <select class="form-select" name="dayOfWeek" required>
                                <option value="">Select day...</option>
                                <option th:each="day : ${T(java.time.DayOfWeek).values()}"
                                        th:value="${day.name()}"
                                        th:text="${day.name()}">
                                    MONDAY
                                </option>
                            </select>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Start Time</label>
                                <input type="time" class="form-control" name="startTime" value="09:00" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">End Time</label>
                                <input type="time" class="form-control" name="endTime" value="17:00" required>
                            </div>
                        </div>
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" name="isHoliday" id="isHoliday">
                            <label class="form-check-label" for="isHoliday">
                                Mark as holiday (day off)
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addSchedule()">Add Schedule</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Schedule Modal -->
    <div class="modal fade" id="editScheduleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title">Edit Working Schedule</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editScheduleForm">
                        <input type="hidden" name="id" id="editScheduleId">
                        <div class="mb-3">
                            <label class="form-label">Staff</label>
                            <input type="text" class="form-control" id="editStaffName" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Day of Week</label>
                            <input type="text" class="form-control" id="editDayName" readonly>
                        </div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Start Time</label>
                                <input type="time" class="form-control" name="startTime" id="editStartTime" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">End Time</label>
                                <input type="time" class="form-control" name="endTime" id="editEndTime" required>
                            </div>
                        </div>
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" name="isHoliday" id="editIsHoliday">
                            <label class="form-check-label" for="editIsHoliday">
                                Mark as holiday (day off)
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="updateSchedule()">Update Schedule</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const CSRF_TOKEN = document.querySelector('input[name="_csrf"]').value;
        
        function addSchedule() {
            const form = document.getElementById('addScheduleForm');
            const formData = new FormData(form);
            
            const scheduleData = {
                staffId: parseInt(formData.get('staffId')),
                dayOfWeek: formData.get('dayOfWeek'),
                startTime: formData.get('startTime') + ':00',
                endTime: formData.get('endTime') + ':00',
                isHoliday: formData.get('isHoliday') === 'on'
            };
            
            // Validate form
            if (!scheduleData.staffId || !scheduleData.dayOfWeek || !scheduleData.startTime || !scheduleData.endTime) {
                alert('Please fill in all required fields');
                return;
            }
            
            // Show loading state
            const submitBtn = document.querySelector('#addScheduleModal .btn-primary');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Adding...';
            
            fetch('/api/schedules', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': CSRF_TOKEN
                },
                body: JSON.stringify(scheduleData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Failed to add schedule');
            })
            .then(data => {
                if (data.success) {
                    // Close modal and reload page
                    bootstrap.Modal.getInstance(document.getElementById('addScheduleModal')).hide();
                    location.reload();
                } else {
                    throw new Error(data.message || 'Failed to add schedule');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error adding schedule: ' + error.message);
            })
            .finally(() => {
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            });
        }
        
        function updateSchedule() {
            const form = document.getElementById('editScheduleForm');
            const formData = new FormData(form);
            
            const scheduleData = {
                id: parseInt(document.getElementById('editScheduleId').value),
                startTime: document.getElementById('editStartTime').value + ':00',
                endTime: document.getElementById('editEndTime').value + ':00',
                isHoliday: document.getElementById('editIsHoliday').checked
            };
            
            const submitBtn = document.querySelector('#editScheduleModal .btn-warning');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Updating...';
            
            fetch(`/api/schedules/${scheduleData.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-TOKEN': CSRF_TOKEN
                },
                body: JSON.stringify(scheduleData)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error('Failed to update schedule');
            })
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editScheduleModal')).hide();
                    location.reload();
                } else {
                    throw new Error(data.message || 'Failed to update schedule');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating schedule: ' + error.message);
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            });
        }
        
        function deleteSchedule(scheduleId) {
            if (!confirm('Are you sure you want to delete this schedule? This action cannot be undone.')) {
                return;
            }
            
            const row = document.getElementById('schedule-' + scheduleId);
            if (row) {
                row.innerHTML = '<td colspan="7" class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Deleting...</td>';
            }
            
            fetch(`/api/schedules/${scheduleId}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': CSRF_TOKEN
                }
            })
            .then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    throw new Error('Failed to delete schedule');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting schedule: ' + error.message);
                if (row) {
                    row.innerHTML = '<td colspan="7" class="text-center text-danger">Error deleting schedule</td>';
                }
            });
        }
        
        // Edit modal setup
        document.getElementById('editScheduleModal').addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const scheduleId = button.getAttribute('data-id');
            const staffId = button.getAttribute('data-staff-id');
            const day = button.getAttribute('data-day');
            const start = button.getAttribute('data-start');
            const end = button.getAttribute('data-end');
            const holiday = button.getAttribute('data-holiday') === 'true';
            
            document.getElementById('editScheduleId').value = scheduleId;
            document.getElementById('editStaffName').value = button.closest('tr').querySelector('td:first-child strong').textContent;
            document.getElementById('editDayName').value = day;
            document.getElementById('editStartTime').value = start.substring(0, 5);
            document.getElementById('editEndTime').value = end.substring(0, 5);
            document.getElementById('editIsHoliday').checked = holiday;
        });
    </script>
</body>
</html>